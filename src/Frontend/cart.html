<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Shopping Cart - RedStore</title>
  <link rel="stylesheet" href="cart.css" />
  <link rel="stylesheet" href="shopping.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
  <!-- Header Section -->
  <header class="header">
    <div class="header-main">
      <div class="container">
        <div class="logo">
          <img src="../../assests/logo-white.png" alt="RedStore" />
        </div>
        
        <div class="search-container">
          <div class="search-box">
            <select class="category-select">
              <option>All Categories</option>
              <option>Electronics</option>
              <option>Fashion</option>
              <option>Home & Kitchen</option>
              <option>Beauty</option>
              <option>Sports</option>
            </select>
            <input type="text" id="searchInput" placeholder="Search for products, brands and more..." />
            <button class="search-btn"><i class="fas fa-search"></i></button>
          </div>
          <div class="search-suggestions" id="searchSuggestions"></div>
        </div>
        
        <div class="header-actions">
          <!-- Auth Buttons (shown when not logged in) -->
          <div class="auth-buttons" id="authButtons" style="display: none;">
            <a href="Login.html" class="auth-btn login-btn">
              <i class="fas fa-sign-in-alt"></i>
              <span>Login</span>
            </a>
            <a href="signup.html" class="auth-btn signup-btn">
              <i class="fas fa-user-plus"></i>
              <span>Sign Up</span>
            </a>
          </div>
          
          <!-- User Menu (shown when logged in) -->
          <div class="user-menu" id="userMenu">
            <button class="user-btn" id="userBtn">
              <i class="fas fa-user"></i>
              <span>Account</span>
            </button>
            <div class="user-dropdown" id="userDropdown">
              <div class="user-info">
                <i class="fas fa-user-circle"></i>
                <span id="userName">Welcome to RedStore</span>
              </div>
              <a href="Account.html" class="dropdown-item"><i class="fas fa-user"></i> My Account</a>
              <a href="cart.html" class="dropdown-item"><i class="fas fa-shopping-cart"></i> Cart</a>
              <a href="#" class="dropdown-item"><i class="fas fa-box"></i> Orders</a>
              <a href="#" class="dropdown-item" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </div>
          </div>
          
          <div class="cart-menu">
            <a href="cart.html" class="cart-btn">
              <i class="fas fa-shopping-cart"></i>
              <span class="cart-count" id="cartCount">0</span>
            </a>
          </div>
        </div>
      </div>
    </div>
    
    <nav class="main-nav">
      <div class="container">
        <div class="nav-left">
          <div class="category-menu">
            <button class="category-btn">
              <i class="fas fa-bars"></i>
              All Categories
            </button>
            <div class="mega-menu" id="megaMenu">
              <div class="mega-menu-content">
                <div class="menu-column">
                  <h4>Electronics</h4>
                  <ul>
                    <li><a href="#">Smartphones</a></li>
                    <li><a href="#">Laptops</a></li>
                    <li><a href="#">TVs & Audio</a></li>
                    <li><a href="#">Cameras</a></li>
                  </ul>
                </div>
                <div class="menu-column">
                  <h4>Fashion</h4>
                  <ul>
                    <li><a href="#">Men's Clothing</a></li>
                    <li><a href="#">Women's Fashion</a></li>
                    <li><a href="#">Kids Wear</a></li>
                    <li><a href="#">Footwear</a></li>
                  </ul>
                </div>
                <div class="menu-column">
                  <h4>Home & Living</h4>
                  <ul>
                    <li><a href="#">Furniture</a></li>
                    <li><a href="#">Kitchen & Dining</a></li>
                    <li><a href="#">Home Decor</a></li>
                    <li><a href="#">Bedding</a></li>
                  </ul>
                </div>
                <div class="menu-column">
                  <h4>Beauty & Health</h4>
                  <ul>
                    <li><a href="#">Makeup</a></li>
                    <li><a href="#">Skincare</a></li>
                    <li><a href="#">Hair Care</a></li>
                    <li><a href="#">Fragrances</a></li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
          <ul class="nav-links">
            <li><a href="shopping.html">Home</a></li>
            <li><a href="#deals">Deals</a></li>
            <li><a href="#new">New Arrivals</a></li>
            <li><a href="#brands">Brands</a></li>
            <li><a href="#offers">Offers</a></li>
          </ul>
        </div>
        <div class="nav-right">
          <div class="location-selector">
            <i class="fas fa-map-marker-alt"></i>
            <span>Deliver to: Address</span>
          </div>
        </div>
      </div>
    </nav>
  </header>

  <!-- Cart Page Content -->
  <main class="cart-page">
    <div class="container">
      <div class="cart-header">
        <h1>Shopping Cart</h1>
        <p id="cartItemCount">0 items</p>
        <button class="btn-secondary" onclick="addSampleItems()" style="margin-top: 10px;">
          <i class="fas fa-plus"></i> Add Sample Items (Test)
        </button>
      </div>

      <div class="cart-layout">
        <!-- Cart Items -->
        <div class="cart-items-section">
          <div class="cart-items-header">
            <h2>Cart Items</h2>
            <button class="clear-cart-btn" onclick="clearCart()">Clear All</button>
          </div>
          
          <div id="cartItems" class="cart-items">
            <!-- Cart items will be populated here -->
          </div>
          
          <div class="empty-cart" id="emptyCart">
            <div class="empty-cart-icon">
              <i class="fas fa-shopping-cart"></i>
            </div>
            <h3>Your cart is empty</h3>
            <p>Add items to your cart to continue shopping</p>
            <a href="shopping.html" class="continue-shopping-btn">
              <i class="fas fa-arrow-left"></i>
              Continue Shopping
            </a>
          </div>
        </div>

        <!-- Order Summary -->
        <div class="order-summary">
          <div class="summary-header">
            <h2>Order Summary</h2>
          </div>
          
          <div class="price-breakdown">
            <div class="price-row">
              <span>Subtotal</span>
              <span>‚Çπ<span id="subtotal">0.00</span></span>
            </div>
            <div class="price-row">
              <span>Discount</span>
              <span class="discount">-‚Çπ<span id="discount">0.00</span></span>
            </div>
            <div class="price-row">
              <span>Delivery Fee</span>
              <span>‚Çπ<span id="deliveryFee">40.00</span></span>
            </div>
            <div class="price-row total">
              <span>Total</span>
              <span>‚Çπ<span id="totalAmount">0.00</span></span>
            </div>
          </div>

          <div class="delivery-info">
            <h3>Delivery Options</h3>
            <div class="delivery-options">
              <div class="delivery-option">
                <input type="radio" id="standard" name="delivery" value="standard" checked>
                <label for="standard">
                  <div class="delivery-type">Standard Delivery</div>
                  <div class="delivery-time">3-5 business days</div>
                </label>
                <div class="delivery-cost">‚Çπ40</div>
              </div>
              <div class="delivery-option">
                <input type="radio" id="express" name="delivery" value="express">
                <label for="express">
                  <div class="delivery-type">Express Delivery</div>
                  <div class="delivery-time">1-2 business days</div>
                </label>
                <div class="delivery-cost">‚Çπ80</div>
              </div>
            </div>
          </div>

          <div class="coupon-section">
            <h3>Apply Coupon</h3>
            <div class="coupon-input">
              <input type="text" id="couponCode" placeholder="Enter coupon code">
              <button class="apply-coupon-btn" onclick="applyCoupon()">Apply</button>
            </div>
            <div class="coupon-message" id="couponMessage"></div>
            <div class="applied-coupon hidden" id="appliedCoupon">
              <span id="appliedCouponText"></span>
              <button class="remove-coupon-btn" onclick="removeCoupon()">Remove</button>
            </div>
          </div>

          <button class="checkout-btn" onclick="proceedToCheckout()" disabled>
            <i class="fas fa-lock"></i>
            Proceed to Checkout
          </button>
          
          <div class="secure-checkout">
            <i class="fas fa-shield-alt"></i>
            <span>Secure Checkout</span>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Enhanced Checkout Modal -->
  <div class="checkout-modal hidden" id="checkoutModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Secure Checkout</h2>
        <button class="close-modal" onclick="closeCheckoutModal()">&times;</button>
      </div>
      
      <div class="checkout-steps">
        <div class="step active" id="step1-indicator">
          <div class="step-number">1</div>
          <div class="step-title">Payment Method</div>
        </div>
        <div class="step" id="step2-indicator">
          <div class="step-number">2</div>
          <div class="step-title">Review & Pay</div>
        </div>
      </div>
      
      <div class="checkout-content">
        <!-- Step 1: Payment Method -->
        <div class="checkout-step active" id="step1">
          <h3>Payment Method</h3>
          <div class="payment-methods" id="paymentMethodsContainer">
            <!-- Saved payment methods will be loaded here -->
          </div>
          <div class="payment-methods">
            <div class="payment-method">
              <input type="radio" id="card" name="payment" value="card">
              <label for="card">
                <i class="fas fa-credit-card"></i>
                Credit/Debit Card
              </label>
            </div>
            <div class="payment-method">
              <input type="radio" id="upi" name="payment" value="upi">
              <label for="upi">
                <i class="fas fa-mobile-alt"></i>
                UPI
              </label>
            </div>
            <div class="payment-method">
              <input type="radio" id="netbanking" name="payment" value="netbanking">
              <label for="netbanking">
                <i class="fas fa-university"></i>
                Net Banking
              </label>
            </div>
            <div class="payment-method">
              <input type="radio" id="cod" name="payment" value="cod">
              <label for="cod">
                <i class="fas fa-money-bill-wave"></i>
                Cash on Delivery
              </label>
            </div>
          </div>
          
          <!-- Payment Details Forms -->
          <div class="payment-details" id="paymentDetails">
            <!-- Card Payment Form -->
            <div class="payment-form hidden" id="cardForm">
              <div class="form-row">
                <div class="form-group">
                  <label>Card Number</label>
                  <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19">
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Card Holder Name</label>
                  <input type="text" id="cardHolder" placeholder="John Doe">
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Expiry Date</label>
                  <input type="text" id="cardExpiry" placeholder="MM/YY" maxlength="5">
                </div>
                <div class="form-group">
                  <label>CVV</label>
                  <input type="password" id="cardCvv" placeholder="123" maxlength="4">
                </div>
              </div>
            </div>
            
            <!-- UPI Payment Form -->
            <div class="payment-form hidden" id="upiForm">
              <div class="form-group">
                <label>UPI ID</label>
                <input type="text" id="upiId" placeholder="username@upi">
              </div>
            </div>
            
            <!-- Net Banking Form -->
            <div class="payment-form hidden" id="netbankingForm">
              <div class="form-group">
                <label>Select Bank</label>
                <select id="bankSelect">
                  <option value="">Choose your bank</option>
                  <option value="sbi">State Bank of India</option>
                  <option value="hdfc">HDFC Bank</option>
                  <option value="icici">ICICI Bank</option>
                  <option value="axis">Axis Bank</option>
                  <option value="kotak">Kotak Mahindra Bank</option>
                </select>
              </div>
            </div>
          </div>
          
          <div class="checkout-actions">
            <button class="btn-secondary" onclick="prevStep()">Back</button>
            <button class="btn-primary" onclick="nextStep()" id="step2-continue" disabled>Continue</button>
          </div>
        </div>

        <!-- Step 2: Review & Pay -->
        <div class="checkout-step" id="step2">
          <h3>üìã Review & Pay</h3>
          

          
          <div class="order-review">
            <div class="review-section">
              <h4>üí≥ Payment Method</h4>
              <p id="selectedPayment">No payment method selected</p>
            </div>
            <div class="review-section">
              <h4>üõçÔ∏è Order Summary</h4>
              <div class="review-items" id="reviewItems">
                <!-- Order items will be shown here -->
              </div>
              <div class="review-total">
                <div class="total-row">
                  <span><strong>Subtotal:</strong></span>
                  <span id="reviewSubtotal"><strong>‚Çπ0.00</strong></span>
                </div>
                <div class="total-row">
                  <span>Delivery Charge:</span>
                  <span id="reviewDelivery">‚Çπ40.00</span>
                </div>
                <div class="total-row total">
                  <span><strong>Total Amount:</strong></span>
                  <span id="reviewTotal"><strong>‚Çπ0.00</strong></span>
                </div>
              </div>
            </div>
          </div>
          <div class="checkout-actions">
            <button class="btn-secondary" onclick="prevStep()">Back</button>
            <button class="btn-primary" onclick="processPayment()" id="payButton">
              <i class="fas fa-lock"></i>
              Pay Now
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Order Confirmation Modal -->
  <div class="order-confirmation-modal hidden" id="orderConfirmationModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üéâ Order Confirmed!</h2>
        <button class="close-modal" onclick="closeOrderConfirmation()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="confirmation-content">
          <div class="success-icon">
            <i class="fas fa-check-circle"></i>
          </div>
          <h3>Thank you for your order!</h3>
          <p class="confirmation-message">Your order has been successfully placed and payment has been processed.</p>
          
          <!-- Product Details Only -->
          <div class="product-summary">
            <h4>üõçÔ∏è Products Ordered</h4>
            <div id="confirmedProducts" class="confirmed-products">
              <!-- Product details will be populated here -->
            </div>
          </div>
          
          <!-- Order Summary -->
          <div class="order-summary">
            <h4>üìã Order Summary</h4>
            <div class="order-details">
              <div class="detail-row">
                <span><i class="fas fa-hashtag"></i> Order ID:</span>
                <span id="confirmedOrderId" class="order-id">#12345</span>
              </div>
              <div class="detail-row">
                <span><i class="fas fa-user"></i> Username:</span>
                <span id="confirmedUsername"></span>
              </div>
              <div class="detail-row">
                <span><i class="fas fa-info-circle"></i> Status:</span>
                <span id="confirmedStatus"></span>
              </div>
              <div class="detail-row">
                <span><i class="fas fa-calendar"></i> Order Date:</span>
                <span id="confirmedDate">Dec 15, 2024</span>
              </div>
              <div class="detail-row">
                <span><i class="fas fa-credit-card"></i> Payment Method:</span>
                <span id="confirmedPayment">Credit Card</span>
              </div>
              <div class="detail-row">
                <span><i class="fas fa-calculator"></i> Subtotal:</span>
                <span id="confirmedSubtotal">‚Çπ0.00</span>
              </div>
              <div class="detail-row">
                <span><i class="fas fa-shipping-fast"></i> Delivery Charge:</span>
                <span id="confirmedDelivery">‚Çπ0.00</span>
              </div>
              <div class="detail-row">
                <span><i class="fas fa-money-bill-wave"></i> Total Amount:</span>
                <span id="confirmedAmount" class="total-amount">‚Çπ0.00</span>
              </div>
            </div>
          </div>
          
          <div class="confirmation-actions">
            <button class="btn-secondary" onclick="continueShopping()">
              <i class="fas fa-shopping-cart"></i> Continue Shopping
            </button>
            <button class="btn-secondary" onclick="testOrderHistory()" style="margin-left: 10px;">
              <i class="fas fa-bug"></i> Test Order History
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentStep = 1;
    let orderData = {};
    let appliedCoupon = null;
    let selectedAddress = null;
    let selectedPaymentMethod = null;
    let paymentFormData = {};

    // Enhanced Local Storage Management
    const STORAGE_KEYS = {
      CART: 'shopHub_cart',
      USER: 'shopHub_user',
      AUTH: 'shopHub_auth',
      WISHLIST: 'shopHub_wishlist',
      RECENT_VIEWS: 'shopHub_recent_views',
      SETTINGS: 'shopHub_settings',
      USER_CARDS: 'shopHub_user_cards',
      USER_ADDRESSES: 'shopHub_user_addresses',
      ORDERS: 'shopHub_orders'
    };

    // Disabled browser localStorage. Keeping no-op API to prevent runtime errors.
    const LocalStorage = {
      get: (_key) => null,
      set: (_key, _value) => false,
      remove: (_key) => false
    };

    // Backend base URL and cookie helpers
    const API_BASE = 'http://localhost:8080/api';
    function setCookie(name, value, days) {
      const d = new Date();
      d.setTime(d.getTime() + (days*24*60*60*1000));
      document.cookie = name + '=' + encodeURIComponent(value) + ';expires=' + d.toUTCString() + ';path=/';
    }
    function getCookie(name) {
      const cname = name + '=';
      const ca = decodeURIComponent(document.cookie).split(';');
      for (let i=0;i<ca.length;i++){ let c=ca[i].trim(); if (c.indexOf(cname)===0) return c.substring(cname.length); }
      return '';
    }
    function eraseCookie(name){ document.cookie = name + '=; Max-Age=0; path=/'; }

    function getAuthUsername() {
      try {
        const fromStorage = localStorage.getItem('auth_username');
        if (fromStorage) return fromStorage;
      } catch (_) {}
      return getCookie('auth_username');
    }

    function getAuthName() {
      try {
        const fromStorage = localStorage.getItem('auth_name');
        if (fromStorage) return fromStorage;
      } catch (_) {}
      return getCookie('auth_name') || getAuthUsername();
    }

    function getLoggedInUsername(){ return getAuthUsername(); }
    let cartCache = [];
    async function loadCartCache(){ const u=getLoggedInUsername(); if(!u){ cartCache=[]; return; } const res=await fetch(`${API_BASE}/cart/${encodeURIComponent(u)}`); cartCache = res.ok ? await res.json() : []; }

    // Check authentication status
    function checkAuthStatus() {
      const username = getLoggedInUsername();
      const authButtons = document.getElementById('authButtons');
      const userMenu = document.getElementById('userMenu');
      const userName = document.getElementById('userName');
      
      if (username) {
        authButtons.style.display = 'none';
        userMenu.style.display = 'block';
        userName.textContent = getAuthName() || username;
      } else {
        authButtons.style.display = 'flex';
        userMenu.style.display = 'none';
      }
    }
    
    // Logout function
    function logout() {
      eraseCookie('auth_username');
      eraseCookie('auth_name');
      try {
        localStorage.removeItem('auth_username');
        localStorage.removeItem('auth_name');
      } catch (_) {}
      window.location.href = 'shopping.html';
    }
    
    // Category menu toggle
    document.querySelector('.category-btn').addEventListener('click', function() {
      document.querySelector('.mega-menu').classList.toggle('active');
    });
    
    // User dropdown toggle
    document.querySelector('.user-btn').addEventListener('click', function() {
      document.querySelector('.user-dropdown').classList.toggle('active');
    });
    
    // Search suggestions
    const searchInput = document.querySelector('.search-box input');
    const searchSuggestions = document.getElementById('searchSuggestions');
    
    searchInput.addEventListener('input', function() {
      const query = this.value.trim();
      if (query.length > 2) {
        const suggestions = [
          `${query} smartphone`,
          `${query} laptop`,
          `${query} shoes`,
          `${query} t-shirt`
        ];
        
        searchSuggestions.innerHTML = suggestions.map(suggestion => 
          `<div class="suggestion-item">${suggestion}</div>`
        ).join('');
        searchSuggestions.style.display = 'block';
      } else {
        searchSuggestions.style.display = 'none';
      }
    });
    
    // Load saved addresses and cards
    function loadSavedData() {
      loadSavedCards();
    }

    // Load saved cards
    function loadSavedCards() { document.getElementById('paymentMethodsContainer').innerHTML = ''; }

    // Enhanced Cart Management Functions
    function getCart() { return cartCache || []; }

    async function updateCartCount() {
      await loadCartCache();
      const cart = getCart();
      const cartCountEl = document.getElementById('cartCount');
      if (cartCountEl) {
        const totalItems = cart.reduce((total, item) => total + (item.quantity || 0), 0);
        cartCountEl.textContent = totalItems;
      }
    }

    // Update cart display
    async function updateCartDisplay() {
      await loadCartCache();
      const cart = getCart();
      console.log('Cart data:', cart); // Debug log
      const cartItemsContainer = document.getElementById('cartItems');
      const emptyCart = document.getElementById('emptyCart');
      const cartItemCount = document.getElementById('cartItemCount');
      const checkoutBtn = document.querySelector('.checkout-btn');
      
      const totalItems = cart.reduce((total, item) => total + item.quantity, 0);
      cartItemCount.textContent = `${totalItems} items`;
      
      if (cart.length === 0) {
        cartItemsContainer.style.display = 'none';
        emptyCart.style.display = 'block';
        checkoutBtn.disabled = true;
        return;
      }
      
      cartItemsContainer.style.display = 'block';
      emptyCart.style.display = 'none';
      checkoutBtn.disabled = false;
      
      cartItemsContainer.innerHTML = cart.map((item, index) => {
        console.log('Item image:', item.image); // Debug log
        return `
        <div class="cart-item">
          <div class="item-image">
                            <img src="${item.imageUrl || item.image || '../../assests/product-1.jpg'}" alt="${item.name}" onerror="this.src='../../assests/product-1.jpg'" onload="console.log('Image loaded:', this.src)" onerror="console.log('Image failed to load:', this.src)">
          </div>
          <div class="item-details">
            <h3>${item.name}</h3>
            <p class="item-description">${item.description || item.name}</p>
            <div class="item-price">‚Çπ${item.price}</div>
          </div>
          <div class="item-quantity">
            <button onclick="updateQuantity('${item.id}', -1)">-</button>
            <span>${item.quantity}</span>
            <button onclick="updateQuantity('${item.id}', 1)">+</button>
          </div>
          <div class="item-total">‚Çπ${(item.price * item.quantity).toFixed(2)}</div>
          <button class="remove-item" onclick="removeFromCart('${item.id}')">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      `}).join('');
      
      updateOrderSummary();
    }

    // Update quantity (server-side)
    async function updateQuantity(itemId, change) {
      try {
        await loadCartCache();
        const current = (cartCache || []).find(i => String(i.id) === String(itemId));
        if (!current) { showNotification('Item not found', 'error'); return; }
        const newQty = (Number(current.quantity) || 0) + Number(change);
        if (newQty <= 0) {
          await fetch(`${API_BASE}/cart/${encodeURIComponent(itemId)}`, { method: 'DELETE' });
        } else {
          await fetch(`${API_BASE}/cart/${encodeURIComponent(itemId)}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ quantity: newQty })
          });
        }
        await loadCartCache();
        await updateCartDisplay();
        showNotification('Quantity updated!', 'success');
      } catch (err) {
        console.error('Failed to update quantity', err);
        showNotification('Failed to update quantity', 'error');
      }
    }

    // Remove from cart (server-side)
    async function removeFromCart(itemId) {
      try {
        await fetch(`${API_BASE}/cart/${encodeURIComponent(itemId)}`, { method: 'DELETE' });
        await loadCartCache();
        await updateCartDisplay();
        showNotification('Item removed from cart!', 'success');
      } catch (err) {
        console.error('Failed to remove item', err);
        showNotification('Failed to remove item', 'error');
      }
    }

    // Clear cart
    async function clearCart() {
      if (!confirm('Are you sure you want to clear your cart?')) return;
      const u = getLoggedInUsername(); if (!u) return;
      await fetch(`${API_BASE}/cart/clear/${encodeURIComponent(u)}`, { method: 'DELETE' });
      await updateCartDisplay();
        showNotification('Cart cleared!');
    }

    // Update order summary
    function updateOrderSummary() {
      const cart = getCart();
      const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      const discount = appliedCoupon ? (subtotal * appliedCoupon.discount / 100) : 0;
      const deliveryFee = 40;
      const total = subtotal - discount + deliveryFee;
      
      document.getElementById('subtotal').textContent = subtotal.toFixed(2);
      document.getElementById('discount').textContent = discount.toFixed(2);
      document.getElementById('totalAmount').textContent = total.toFixed(2);
    }

    // Apply coupon
    function applyCoupon() {
      const couponCode = document.getElementById('couponCode').value.trim().toUpperCase();
      const messageEl = document.getElementById('couponMessage');
      const appliedEl = document.getElementById('appliedCoupon');
      const appliedText = document.getElementById('appliedCouponText');
      
      const validCoupons = {
        'WELCOME10': { discount: 10, minAmount: 500 },
        'SAVE200': { discount: 200, minAmount: 1000 }
      };
      
      if (validCoupons[couponCode]) {
        const cart = getCart() || [];
        const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        
        if (subtotal >= validCoupons[couponCode].minAmount) {
          appliedCoupon = { code: couponCode, ...validCoupons[couponCode] };
          appliedText.textContent = `${couponCode} - ${validCoupons[couponCode].discount}% OFF`;
          appliedEl.classList.remove('hidden');
          messageEl.textContent = 'Coupon applied successfully!';
          messageEl.className = 'coupon-message success';
          updateOrderSummary();
        } else {
          messageEl.textContent = `Minimum order amount of ‚Çπ${validCoupons[couponCode].minAmount} required`;
          messageEl.className = 'coupon-message error';
        }
      } else {
        messageEl.textContent = 'Invalid coupon code';
        messageEl.className = 'coupon-message error';
      }
    }

    // Remove coupon
    function removeCoupon() {
      appliedCoupon = null;
      document.getElementById('appliedCoupon').classList.add('hidden');
      document.getElementById('couponMessage').textContent = '';
      document.getElementById('couponCode').value = '';
      updateOrderSummary();
    }

    // Proceed to checkout
    function proceedToCheckout() {
      const username = getLoggedInUsername();
      if (!username) {
        alert('Please login to proceed with checkout');
        window.location.href = 'Login.html';
        return;
      }
      document.getElementById('checkoutModal').classList.remove('hidden');
      showStep(1);
    }

    // Show step
    function showStep(step) {
      // Hide all steps first
      document.querySelectorAll('.checkout-step').forEach(s => {
        s.classList.remove('active');
        s.style.display = 'none';
      });
      
      // Show only the current step
      const currentStepElement = document.getElementById(`step${step}`);
      if (currentStepElement) {
        currentStepElement.classList.add('active');
        currentStepElement.style.display = 'block';
      }
      
      // Update step indicators
      document.querySelectorAll('.step').forEach((s, index) => {
        s.classList.remove('active', 'completed');
        if (index + 1 === step) {
          s.classList.add('active');
        } else if (index + 1 < step) {
          s.classList.add('completed');
        }
      });
      
      currentStep = step;
      
      // Load step-specific content
      if (step === 1) {
        loadSavedCards();
        // Add a small delay to ensure DOM is ready
        setTimeout(() => {
          setupPaymentMethodListeners();
        }, 100);
      } else if (step === 2) {
        updateReviewStep();
      }
    }

    // Next step
    function nextStep() {
      if (currentStep === 1) {
        if (!selectedPaymentMethod) {
          showNotification('Please select a payment method', 'error');
          return;
        }
        
        // Validate payment form data
        if (!validatePaymentForm()) {
          return;
        }
        
        showStep(2);
      }
    }

    // Previous step
    function prevStep() {
      if (currentStep > 1) {
        showStep(currentStep - 1);
      }
    }

    // Update review step
    function updateReviewStep() {
      const cart = getCart() || [];
      const selectedPayment = document.querySelector('input[name="payment"]:checked');
      
      console.log('=== DEBUGGING REVIEW STEP ===');
      console.log('Cart from server cache:', cart);
      console.log('Cart length:', cart.length);
      console.log('Cart items:', cart);
      
      // Debug localStorage directly
      // No browser localStorage used
      
      if (cart.length > 0) {
        console.log('First item:', cart[0]);
        console.log('First item price:', cart[0].price);
        console.log('First item quantity:', cart[0].quantity);
        console.log('First item price type:', typeof cart[0].price);
        console.log('First item quantity type:', typeof cart[0].quantity);
      }
      
      if (selectedPayment) {
        let paymentText = selectedPayment.value.toUpperCase();
        
        // Handle saved payment methods
        if (selectedPayment.value.startsWith('saved_')) {
          const savedCards = [];
          const userCards = [];
          const cardIndex = parseInt(selectedPayment.value.split('_')[1]);
          const selectedCard = userCards[cardIndex];
          
          if (selectedCard) {
            paymentText = `${selectedCard.type} ending in ${selectedCard.number.slice(-4)}`;
          }
        }
        
        document.getElementById('selectedPayment').textContent = paymentText;
      }
      
      // Update review items with detailed information
      const reviewItems = document.getElementById('reviewItems');
      if (cart.length === 0) {
        reviewItems.innerHTML = `
          <div class="empty-review">
            <p>No items in cart</p>
          </div>
        `;
      } else {
        reviewItems.innerHTML = cart.map(item => `
          <div class="review-item">
            <div class="review-item-image">
              <img src="${item.imageUrl || item.image || '../../assests/product-1.jpg'}" alt="${item.name}" onerror="this.src='../../assests/product-1.jpg'">
            </div>
            <div class="review-item-details">
              <h5>${item.name}</h5>
              <div class="review-item-info">
                <p><strong>Price:</strong> ‚Çπ${item.price.toFixed(2)} each</p>
                <p><strong>Quantity:</strong> ${item.quantity}</p>
                <p><strong>Item Total:</strong> ‚Çπ${(item.price * item.quantity).toFixed(2)}</p>
              </div>
            </div>
          </div>
        `).join('');
      }
      
      // Calculate and update totals
      const subtotal = cart.reduce((sum, item) => {
        const price = parseFloat(item.price) || 0;
        const quantity = parseInt(item.quantity) || 0;
        console.log(`Item: ${item.name}, Price: ${price}, Quantity: ${quantity}, Item Total: ${price * quantity}`);
        return sum + (price * quantity);
      }, 0);
      const deliveryCharge = 40;
      const total = subtotal + deliveryCharge;
      
      console.log('Calculated totals:', { subtotal, deliveryCharge, total });
      
      // Update review totals
      const reviewSubtotal = document.getElementById('reviewSubtotal');
      const reviewDelivery = document.getElementById('reviewDelivery');
      const reviewTotal = document.getElementById('reviewTotal');
      
      if (reviewSubtotal) reviewSubtotal.textContent = `‚Çπ${subtotal.toFixed(2)}`;
      if (reviewDelivery) reviewDelivery.textContent = `‚Çπ${deliveryCharge.toFixed(2)}`;
      if (reviewTotal) reviewTotal.textContent = `‚Çπ${total.toFixed(2)}`;
      
      // Update top summary section
      const topSubtotal = document.getElementById('topSubtotal');
      const topDelivery = document.getElementById('topDelivery');
      const topTotal = document.getElementById('topTotal');
      
      if (topSubtotal) topSubtotal.textContent = `‚Çπ${subtotal.toFixed(2)}`;
      if (topDelivery) topDelivery.textContent = `‚Çπ${deliveryCharge.toFixed(2)}`;
      if (topTotal) topTotal.textContent = `‚Çπ${total.toFixed(2)}`;
      
      console.log('Review step updated successfully');
    }

    // Process payment
    async function processPayment() {
      const payButton = document.getElementById('payButton');
      payButton.disabled = true;
      payButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing Payment...';
      
      try {
        await loadCartCache();
        const cart = getCart();
        const username = getLoggedInUsername();
        if (!username) { alert('Please login.'); return; }

        // Totals
        const subtotal = cart.reduce((sum, item) => sum + (Number(item.price) * Number(item.quantity)), 0);
        const isExpress = document.getElementById('express') && document.getElementById('express').checked;
        const deliveryFee = isExpress ? 80 : 40;
        const totalAmount = subtotal + deliveryFee;

        // Order payload for backend
        const productName = cart.map(i => `${i.name} x${i.quantity}`).join(', ');
        // Get product image from first cart item (or combine if multiple items)
        const productImage = cart.length > 0 ? cart[0].imageUrl : '';
        // Create a combined image string for multiple products (first 3 images)
        const productImages = cart.slice(0, 3).map(item => item.imageUrl).join('|');
        
        // Resolve default address from backend
        let deliveryAddress = 'No default address set';
        // Get fullName from the first cart item (all items should have the same fullName for a user)
        let fullName = cart.length > 0 ? cart[0].fullName : username;
        try {
          const respAddr = await fetch(`${API_BASE}/addresses/${encodeURIComponent(username)}`);
          if (respAddr.ok) {
            const addrList = await respAddr.json();
            const def = addrList.find(a => a.isDefault) || addrList[0];
            if (def) {
              deliveryAddress = `${def.fullName}, ${def.addressLine1}${def.addressLine2 ? ', ' + def.addressLine2 : ''}, ${def.city}, ${def.state} ${def.pincode}`;
            }
          }
        } catch (_) {}

        const totalQty = cart.reduce((sum, i) => sum + Number(i.quantity || 0), 0);
        const payload = {
          username: username,
          fullName: fullName,
          paymentMethod: selectedPaymentMethod || 'cod',
          totalAmount: totalAmount,
          quantity: totalQty,
          status: 'PENDING',
          productName: productName,
          productRate: subtotal,
          productImage: productImage,
          deliveryAddress: deliveryAddress
        };

        const res = await fetch(`${API_BASE}/orders`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error('Failed to place order');
        const created = await res.json();

        // Clear server cart: mark all ACTIVE items as ORDERED
        await fetch(`${API_BASE}/cart/mark-ordered/${encodeURIComponent(username)}`, { method: 'PUT' });
        await loadCartCache();
        updateCartDisplay();
        
        const order = {
          id: created.orderId,
          number: created.orderNumber,
          items: cart,
          total: totalAmount,
          paymentMethod: payload.paymentMethod
        };
        showPaymentSuccess(order);
      } catch (e) {
        showNotification('Payment failed. Please try again.', 'error');
      } finally {
        const btn = document.getElementById('payButton');
        if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-lock"></i> Pay Now'; }
      }
    }
    
    // Place order (legacy function)
    function placeOrder() {
      processPayment();
    }

    // Show payment success
    function showPaymentSuccess(order) {
      document.getElementById('checkoutModal').classList.add('hidden');
      
      // Calculate subtotal from order items
      const subtotal = order.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      const deliveryCharge = order.total - subtotal;
      
      // Update basic order details
      document.getElementById('confirmedOrderId').textContent = order.number || order.id;
      const username = getLoggedInUsername();
      document.getElementById('confirmedUsername').textContent = username || '';
      const confirmedPhoneEl = document.getElementById('confirmedPhone');
      if (confirmedPhoneEl) confirmedPhoneEl.textContent = '';
      document.getElementById('confirmedStatus').textContent = (order.status || 'PENDING');
      document.getElementById('confirmedSubtotal').textContent = `‚Çπ${subtotal.toFixed(2)}`;
      document.getElementById('confirmedDelivery').textContent = `‚Çπ${deliveryCharge.toFixed(2)}`;
      document.getElementById('confirmedAmount').textContent = `‚Çπ${order.total.toFixed(2)}`;
      document.getElementById('confirmedDate').textContent = new Date().toLocaleDateString();
      
      // Update payment method with details
      let paymentText = order.paymentMethod.toUpperCase();
      if (order.paymentMethod === 'card' && paymentFormData.cardNumber) {
        paymentText = `Credit/Debit Card ending in ${paymentFormData.cardNumber.slice(-4)}`;
      } else if (order.paymentMethod === 'upi' && paymentFormData.upiId) {
        paymentText = `UPI: ${paymentFormData.upiId}`;
      } else if (order.paymentMethod === 'netbanking' && paymentFormData.bank) {
        paymentText = `Net Banking: ${paymentFormData.bank.toUpperCase()}`;
      } else if (order.paymentMethod === 'cod') {
        paymentText = 'Cash on Delivery';
      }
      document.getElementById('confirmedPayment').textContent = paymentText;
      
      // Populate product details only (no images)
      const confirmedProducts = document.getElementById('confirmedProducts');
      confirmedProducts.innerHTML = order.items.map(item => `
        <div class="confirmed-product-item">
          <div class="product-info">
            <h5>${item.name}</h5>
            <p>Quantity: ${item.quantity}</p>
            <p>Price: ‚Çπ${item.price.toFixed(2)} each</p>
            <span class="item-total">‚Çπ${(item.price * item.quantity).toFixed(2)}</span>
          </div>
        </div>
      `).join('');
      
      document.getElementById('orderConfirmationModal').classList.remove('hidden');
    }
    
    // Show order confirmation (legacy function)
    function showOrderConfirmation(order) {
      showPaymentSuccess(order);
    }

    // View order
    function viewOrder() {
      console.log('View order function called');
      closeOrderConfirmation();
      
      // Show loading message
      showNotification('Redirecting to your orders...', 'info');
      
      // Try to redirect to account page
      try {
        console.log('Attempting to redirect to Account.html');
        window.location.href = 'Account.html?from=cart';
      } catch (error) {
        console.error('Error redirecting to account page:', error);
        // Fallback: try to open in new tab
        window.open('Account.html?from=cart', '_blank');
      }
    }
    


    // Continue shopping
    function continueShopping() { closeOrderConfirmation(); window.location.href = 'shopping.html'; }

    // Test order history function
    function testOrderHistory() {
      console.log('=== TESTING ORDER HISTORY ===');
      
      console.log('Orders are now stored in the backend.');
      
      showNotification('Order history test completed. Check console for details.', 'info');
    }

    // Add sample items to cart for testing
    function addSampleItems() {
      const sampleItems = [
        {
          id: 'sample1',
          name: 'Sample Product 1',
          price: 999.99,
          quantity: 2,
          image: '../../assests/product-1.jpg',
          description: 'This is a sample product for testing'
        },
        {
          id: 'sample2',
          name: 'Sample Product 2',
          price: 1499.99,
          quantity: 1,
          image: '../../assests/product-2.jpg',
          description: 'Another sample product for testing'
        }
      ];
      
      cartCache = sampleItems;
      updateCartDisplay();
      showNotification('Sample items added to cart for testing!', 'success');
    }

    // Close order confirmation
    function closeOrderConfirmation() {
      document.getElementById('orderConfirmationModal').classList.add('hidden');
    }

    // Close checkout modal
    function closeCheckoutModal() {
      document.getElementById('checkoutModal').classList.add('hidden');
      // Reset to first step
      currentStep = 1;
      orderData = {};
      selectedPaymentMethod = null;
      paymentFormData = {};
      showStep(1);
      
      // Reset form fields
      document.querySelectorAll('input[name="payment"]').forEach(input => {
        input.checked = false;
      });
      
      // Hide all payment forms
      document.querySelectorAll('.payment-form').forEach(form => {
        form.classList.add('hidden');
      });
      
      // Reset payment form fields
      const cardNumber = document.getElementById('cardNumber');
      const cardHolder = document.getElementById('cardHolder');
      const cardExpiry = document.getElementById('cardExpiry');
      const cardCvv = document.getElementById('cardCvv');
      const upiId = document.getElementById('upiId');
      const bankSelect = document.getElementById('bankSelect');
      
      if (cardNumber) cardNumber.value = '';
      if (cardHolder) cardHolder.value = '';
      if (cardExpiry) cardExpiry.value = '';
      if (cardCvv) cardCvv.value = '';
      if (upiId) upiId.value = '';
      if (bankSelect) bankSelect.value = '';
      
      // Disable continue buttons
      const step1Continue = document.getElementById('step1-continue');
      const step2Continue = document.getElementById('step2-continue');
      if (step1Continue) step1Continue.disabled = true;
      if (step2Continue) step2Continue.disabled = true;
    }

    // Initialize
    (async function initCartPage(){
    checkAuthStatus();
      await loadCartCache();
    updateCartDisplay();
    loadSavedData();
    })();
    
    // Check if cart is empty and show appropriate message
    function checkCartStatus() {
      const cart = getCart() || [];
      if (cart.length === 0) {
        // Show empty cart message
        const cartContainer = document.querySelector('.cart-items');
        if (cartContainer) {
          cartContainer.innerHTML = `
            <div class="empty-cart">
              <i class="fas fa-shopping-cart"></i>
              <h3>Your cart is empty</h3>
              <p>Add some products to get started!</p>
              <a href="shopping.html" class="btn-primary">Continue Shopping</a>
            </div>
          `;
        }
        
        // Disable checkout button
        const checkoutBtn = document.querySelector('.checkout-btn');
        if (checkoutBtn) {
          checkoutBtn.disabled = true;
        }
      }
    }
    
    // Call cart status check
    checkCartStatus();
    
    // Show notification function
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#17a2b8'};
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        z-index: 10000;
        font-weight: 500;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideIn 0.3s ease;
      `;
      
      // Add CSS animation
      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideIn {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
      `;
      document.head.appendChild(style);
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }
    
    // Create sample payment methods for testing (remove in production)
    function createSamplePaymentMethods() { /* removed local storage sample cards */ }
    
    // Create sample addresses for testing (remove in production)
    function createSampleAddresses() { /* removed local storage sample addresses */ }
    
    // Load saved cards
    function loadSavedCards() { const cardContainer = document.getElementById('paymentMethodsContainer'); if (cardContainer) cardContainer.innerHTML=''; }





    // Setup payment method listeners
    function setupPaymentMethodListeners() {
      console.log('Setting up payment method listeners...');
      
      // Get all payment radio buttons
      const cardRadio = document.getElementById('card');
      const upiRadio = document.getElementById('upi');
      const netbankingRadio = document.getElementById('netbanking');
      const codRadio = document.getElementById('cod');
      
      console.log('Found radio buttons:', { cardRadio, upiRadio, netbankingRadio, codRadio });
      
      // Remove all existing listeners
      if (cardRadio) {
        cardRadio.onclick = null;
        cardRadio.onchange = null;
      }
      if (upiRadio) {
        upiRadio.onclick = null;
        upiRadio.onchange = null;
      }
      if (netbankingRadio) {
        netbankingRadio.onclick = null;
        netbankingRadio.onchange = null;
      }
      if (codRadio) {
        codRadio.onclick = null;
        codRadio.onchange = null;
      }
      
      // Add new listeners
      if (cardRadio) {
        cardRadio.onclick = function() {
          console.log('Card payment selected');
          selectedPaymentMethod = 'card';
          this.checked = true;
          showPaymentForm('card');
          document.getElementById('step2-continue').disabled = false;
        };
      }
      
      if (upiRadio) {
        upiRadio.onclick = function() {
          console.log('UPI payment selected');
          selectedPaymentMethod = 'upi';
          this.checked = true;
          showPaymentForm('upi');
          document.getElementById('step2-continue').disabled = false;
        };
      }
      
      if (netbankingRadio) {
        netbankingRadio.onclick = function() {
          console.log('Net Banking payment selected');
          selectedPaymentMethod = 'netbanking';
          this.checked = true;
          showPaymentForm('netbanking');
          document.getElementById('step2-continue').disabled = false;
        };
      }
      
      if (codRadio) {
        codRadio.onclick = function() {
          console.log('Cash on Delivery selected');
          selectedPaymentMethod = 'cod';
          this.checked = true;
          showPaymentForm('cod');
          document.getElementById('step2-continue').disabled = false;
        };
      }
      
      console.log('Payment method listeners setup complete');
    }
    
    // Handle payment method click
    function handlePaymentMethodClick() {
      console.log('Payment method clicked:', this.value);
      this.checked = true;
      selectedPaymentMethod = this.value;
      showPaymentForm(this.value);
      document.getElementById('step2-continue').disabled = false;
    }
    
    // Handle payment method change
    function handlePaymentMethodChange() {
      console.log('Payment method changed to:', this.value);
      selectedPaymentMethod = this.value;
      showPaymentForm(this.value);
      document.getElementById('step2-continue').disabled = false;
    }
    


    // Show payment form based on selection
    function showPaymentForm(method) {
      console.log('Showing payment form for method:', method);
      
      // Hide all forms first
      document.querySelectorAll('.payment-form').forEach(form => {
        form.classList.add('hidden');
        console.log('Hiding form:', form.id);
      });
      
      // Show payment details section
      const paymentDetails = document.getElementById('paymentDetails');
      if (paymentDetails) {
        paymentDetails.style.display = 'block';
        console.log('Payment details section shown');
      }
      
      // Show selected form
      if (method === 'card') {
        const cardForm = document.getElementById('cardForm');
        if (cardForm) {
          cardForm.classList.remove('hidden');
          cardForm.style.display = 'block';
          console.log('Card form shown successfully');
        } else {
          console.error('Card form not found');
        }
      } else if (method === 'upi') {
        const upiForm = document.getElementById('upiForm');
        if (upiForm) {
          upiForm.classList.remove('hidden');
          upiForm.style.display = 'block';
          console.log('UPI form shown successfully');
        } else {
          console.error('UPI form not found');
        }
      } else if (method === 'netbanking') {
        const netbankingForm = document.getElementById('netbankingForm');
        if (netbankingForm) {
          netbankingForm.classList.remove('hidden');
          netbankingForm.style.display = 'block';
          console.log('Net Banking form shown successfully');
        } else {
          console.error('Net Banking form not found');
        }
      } else if (method === 'cod') {
        // Cash on Delivery - no form needed
        // Hide payment details section completely
        if (paymentDetails) {
          paymentDetails.style.display = 'none';
          console.log('Payment details hidden for COD');
        }
      }
    }

    // Validate payment form
    function validatePaymentForm() {
      if (selectedPaymentMethod === 'card') {
        const cardNumber = document.getElementById('cardNumber').value;
        const cardHolder = document.getElementById('cardHolder').value;
        const cardExpiry = document.getElementById('cardExpiry').value;
        const cardCvv = document.getElementById('cardCvv').value;
        
        if (!cardNumber || !cardHolder || !cardExpiry || !cardCvv) {
          showNotification('Please fill all card details', 'error');
          return false;
        }
        
        paymentFormData = {
          cardNumber: cardNumber,
          cardHolder: cardHolder,
          cardExpiry: cardExpiry,
          cardCvv: cardCvv
        };
        
      } else if (selectedPaymentMethod === 'upi') {
        const upiId = document.getElementById('upiId').value;
        
        if (!upiId) {
          showNotification('Please enter UPI ID', 'error');
          return false;
        }
        
        paymentFormData = { upiId: upiId };
        
      } else if (selectedPaymentMethod === 'netbanking') {
        const bankSelect = document.getElementById('bankSelect').value;
        
        if (!bankSelect) {
          showNotification('Please select a bank', 'error');
          return false;
        }
        
        paymentFormData = { bank: bankSelect };
        
      } else if (selectedPaymentMethod === 'cod') {
        // Cash on Delivery - no validation needed
        paymentFormData = { method: 'cod' };
        return true;
      } else {
        showNotification('Please select a valid payment method', 'error');
        return false;
      }
      
      return true;
    }

    // Update review step
    function updateReviewStep() {
      // Update payment method
      if (selectedPaymentMethod) {
        let paymentText = selectedPaymentMethod.toUpperCase();
        if (selectedPaymentMethod === 'card' && paymentFormData.cardNumber) {
          paymentText = `Card ending in ${paymentFormData.cardNumber.slice(-4)}`;
        } else if (selectedPaymentMethod === 'upi' && paymentFormData.upiId) {
          paymentText = `UPI: ${paymentFormData.upiId}`;
        } else if (selectedPaymentMethod === 'netbanking' && paymentFormData.bank) {
          paymentText = `Net Banking: ${paymentFormData.bank.toUpperCase()}`;
        } else if (selectedPaymentMethod === 'cod') {
          paymentText = `Cash on Delivery`;
        }
        document.getElementById('selectedPayment').textContent = paymentText;
      }
      
      // Update order summary
      const cart = getCart() || [];
      const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      const isExpress = document.getElementById('express') && document.getElementById('express').checked;
      const deliveryFee = isExpress ? 80 : 40;
      const total = subtotal + deliveryFee;
      
      document.getElementById('reviewSubtotal').textContent = `‚Çπ${subtotal.toFixed(2)}`;
      document.getElementById('reviewDelivery').textContent = `‚Çπ${deliveryFee}`;
      document.getElementById('reviewTotal').textContent = `‚Çπ${total.toFixed(2)}`;
      
      const reviewItems = document.getElementById('reviewItems');
      reviewItems.innerHTML = cart.map(item => `
        <div class="review-item">
          <img src="${item.imageUrl || item.image || '../../assests/product-1.jpg'}" alt="${item.name}" onerror="this.src='../../assests/product-1.jpg'">
          <div class="review-item-details">
            <h5>${item.name}</h5>
            <p>Qty: ${item.quantity}</p>
            <span>‚Çπ${(item.price * item.quantity).toFixed(2)}</span>
          </div>
        </div>
      `).join('');
    }



    // Format card number with spaces
    document.addEventListener('DOMContentLoaded', function() {
      const cardNumberInput = document.getElementById('cardNumber');
      if (cardNumberInput) {
        cardNumberInput.addEventListener('input', function(e) {
          let value = e.target.value.replace(/\s/g, '');
          value = value.replace(/\D/g, '');
          value = value.replace(/(\d{4})(?=\d)/g, '$1 ');
          e.target.value = value;
        });
      }

      const cardExpiryInput = document.getElementById('cardExpiry');
      if (cardExpiryInput) {
        cardExpiryInput.addEventListener('input', function(e) {
          let value = e.target.value.replace(/\D/g, '');
          if (value.length >= 2) {
            value = value.substring(0, 2) + '/' + value.substring(2, 4);
          }
          e.target.value = value;
        });
      }
    });



    // Create sample payment methods for testing
    function createSamplePaymentMethods() { /* removed */ }

    // Notification system
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.classList.add('show');
      }, 100);
      
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 300);
      }, 3000);
    }

    // Initialize cart page
    window.onload = function() {
      checkAuthStatus();
      updateCartDisplay();
      loadSavedData();
      
      // Setup payment method listeners
      setTimeout(() => {
        setupPaymentMethodListeners();
      }, 200);
      
      // Show welcome message if cart has items
      const cart = getCart();
      if (cart.length > 0) {
        showNotification(`You have ${cart.length} items in your cart!`);
      }
    };

    // Export functions for use in other pages
    window.ShopHub = {
      getCart,
      saveCart,
      updateCartCount,
      addToCart: function(productName, price, imageUrl, description) {
        const cart = getCart();
        const existingItem = cart.find(item => item.name === productName);
        
        if (existingItem) {
          existingItem.quantity += 1;
        } else {
          cart.push({
            id: Date.now().toString(),
            name: productName,
            price: price,
            quantity: 1,
            image: imageUrl,
            description: description || productName,
            addedAt: new Date().toISOString()
          });
        }
        
        saveCart(cart);
        showNotification(`${productName} added to cart!`);
      },
      LocalStorage,
      STORAGE_KEYS
    };

    // Uncomment the lines below to create sample data for testing
    // createSamplePaymentMethods();
  </script>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-container">
      <div class="footer-column">
        <h3>About RedStore</h3>
        <ul>
          <li><a href="#">About Us</a></li>
          <li><a href="#">Careers</a></li>
          <li><a href="#">Press & Media</a></li>
          <li><a href="#">RedStore Science</a></li>
          <li><a href="#">Investor Relations</a></li>
        </ul>
      </div>

      <div class="footer-column">
        <h3>Connect With Us</h3>
        <ul>
          <li><a href="#">Facebook</a></li>
          <li><a href="#">Twitter</a></li>
          <li><a href="#">Instagram</a></li>
          <li><a href="#">YouTube</a></li>
          <li><a href="#">LinkedIn</a></li>
        </ul>
        <div class="contact-info">
          <p><i class="fas fa-phone"></i> 9492451504</p>
          <p><i class="fas fa-envelope"></i> <a href="mailto:mothukuriomeprakash@gmail.com">mothukuriomeprakash@gmail.com</a></p>
        </div>
      </div>

      <div class="footer-column">
        <h3>Make Money With Us</h3>
        <ul>
          <li><a href="#">Sell on RedStore</a></li>
          <li><a href="#">Become an Affiliate</a></li>
          <li><a href="#">Advertise Your Products</a></li>
          <li><a href="#">RedStore Pay</a></li>
          <li><a href="#">RedStore Business</a></li>
          <li><a href="#">RedStore Fresh</a></li>
          <li><a href="#">RedStore Prime</a></li>
        </ul>
      </div>

      <div class="footer-column">
        <h3>Let Us Help You</h3>
        <ul>
          <li><a href="#">Your Account</a></li>
          <li><a href="#">Returns Centre</a></li>
          <li><a href="#">100% Purchase Protection</a></li>
          <li><a href="#">RedStore App Download</a></li>
          <li><a href="#">Help</a></li>
          <li><a href="#">Customer Service</a></li>
        </ul>
      </div>
    </div>

    <div class="footer-separator"></div>

    <div class="footer-bottom">
      <div class="footer-bottom-content">
        <div class="footer-logo">
          <span class="logo-text">RedStore</span>
        </div>
        <div class="footer-language">
          <select class="language-select">
            <option>English</option>
            <option>Hindi</option>
            <option>Telugu</option>
            <option>Tamil</option>
          </select>
          <span class="country">India</span>
        </div>
      </div>
      <div class="footer-links">
        <a href="#">Conditions of Use & Sale</a>
        <a href="#">Privacy Notice</a>
        <a href="#">Interest-Based Ads</a>
        <a href="#">Cookie Preferences</a>
        <span class="copyright">¬© 2025 RedStore.com, Inc. All rights reserved.</span>
      </div>
    </div>
  </footer>
</body>
</html>